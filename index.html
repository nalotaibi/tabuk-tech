<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-35NPHCGB93"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-35NPHCGB93');
  </script>

  <link rel="apple-touch-icon" href="1024.png">
  <link rel="icon" href="1024.png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø­Ø§Ø³Ø¨Ø© Ø§Ù„ØºÙŠØ§Ø¨</title>

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #006699;
      --secondary: #00aed9;
      --text-dark: #2c3e50;

      --safe: #22c55e;
      --warning: #facc15;
      --orange: #fb923c;
      --danger: #ef4444;

      --bg-gradient: linear-gradient(135deg, #e6f4f8 0%, #ffffff 100%);

      --info-modal-bg: #ffffff;
      --info-modal-text: #1f2937;
      --info-modal-accent: #0EA5E9;
    }

    .num{
      direction: ltr;
      unicode-bidi: isolate;
      display: inline-block;
      font-weight: 800;
    }

    .formula-line{
      direction: rtl;
      unicode-bidi: isolate-override;
      text-align: center;
      white-space: nowrap;
    }

    body {
      margin: 0;
      font-family: 'Cairo', 'Segoe UI', Tahoma, sans-serif;
      background: var(--bg-gradient);
      padding: 20px 10px;
      direction: rtl;
      min-height: 100vh;
    }

    .install-banner {
      background: #ffffff;
      border: 1px solid #e1e9e7;
      padding: 4px 12px;
      border-radius: 14px;
      margin-bottom: 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 3px 8px rgba(0,0,0,0.03);
    }

    .install-text {
      font-weight: 600;
      color: var(--primary);
      font-size: 0.78rem;
    }

    .install-btn {
      background: var(--secondary);
      color: white;
      border: none;
      padding: 4px 12px;
      border-radius: 10px;
      font-size: 0.72rem;
      font-weight: bold;
      cursor: pointer;
    }

    .app-container { max-width: 450px; margin: 0 auto; }
    .header-section { text-align: center; margin-bottom: 20px; }

    .college-logo img {
      width: clamp(220px, 60vw, 300px);
      margin-bottom: 0px;
      filter: drop-shadow(0 3px 6px rgba(0,0,0,0.12));
    }

    .header-text h1 {
      margin: 0;
      font-size: clamp(1.9rem, 4.8vw, 2.5rem);
      font-weight: 800;
      color: var(--primary);
      letter-spacing: 0.3px;
    }

    .system-badge {
      display: inline-block;
      margin-top: 8px;
      padding: 4px 12px;
      background: #e0f2f1;
      color: #00796b;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: bold;
    }

    .system-16 { background: #ecfdf5; color: #047857; }
    .system-15 { background: #e0f2fe; color: #0369a1; }

    .action-bars { display: flex; gap: 10px; margin: 20px 0; }
    .add-btn {
      flex: 2;
      padding: 14px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      border: none;
      border-radius: 16px;
      font-weight: bold;
      cursor: pointer;
      font-size: 1.05rem;
      letter-spacing: 0.3px;
      box-shadow: 0 4px 12px rgba(0, 102, 153, 0.2);
    }
    .reset-all {
      flex: 1;
      padding: 12px;
      background: #fff;
      color: var(--primary);
      border: 1px solid var(--primary);
      border-radius: 16px;
      cursor: pointer;
      font-weight: bold;
    }

    .course-card {
      background: white;
      border-radius: 28px;
      padding: 22px;
      margin-bottom: 20px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.06);
      border: 1px solid #d1e2e8;
      position: relative;
    }

    .delete-course {
      position: absolute;
      top: 18px;
      left: 18px;
      background: #fee2e2;
      color: #ef4444;
      border: none;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .course-title {
      width: 85%;
      border: none;
      border-bottom: 2px solid #f0f0f0;
      font-size: 1.1rem;
      font-weight: bold;
      color: var(--primary);
      margin-bottom: 15px;
      padding: 5px;
      outline: none;
      background: transparent;
    }

    .input-group { margin-bottom: 12px; }
    .input-group label {
      display: block;
      font-size: 0.9rem;
      color: #334155;
      margin-bottom: 6px;
      font-weight: 800;
      background: #f0f7f9;
      padding: 6px 12px;
      border-right: 3px solid var(--secondary);
    }

    select, input {
      width: 100%;
      padding: 10px;
      border-radius: 12px;
      border: 1.5px solid #edf2f1;
      font-family: inherit;
      text-align: center;
      font-size: 0.95rem;
      outline: none;
      box-sizing: border-box;
      transition: all 0.3s;
    }

    input:focus { border-color: var(--secondary); background: #f8fdff; }
    .flex-inputs { display: flex; gap: 8px; align-items: flex-end; }
    .flex-inputs > div { flex: 1; }

    .input-sub-label {
      font-size: 0.8rem;
      color: #666;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 2px;
      font-weight: 600;
      width: 100%;      
      white-space: nowrap;
    }

    .info-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      background: var(--info-modal-accent);
      color: white;
      border-radius: 999px;
      font-size: 0.78rem;
      margin-right: 6px;
      cursor: pointer;
      font-weight: 900;
      vertical-align: middle;
      box-shadow: 0 6px 14px rgba(14,165,233,0.25);
      transition: transform 0.15s ease, filter 0.15s ease, background 0.2s ease;
    }
    .info-icon:hover { filter: brightness(1.05); }
    .info-icon:active { transform: translateY(1px) scale(0.98); }
    .info-icon.warn { background: var(--orange); box-shadow: 0 6px 14px rgba(251,146,60,0.25); }
    .info-icon.danger { background: var(--danger); box-shadow: 0 6px 14px rgba(239,68,68,0.25); }

    .result-area { border-radius: 20px; padding: 15px; margin-top: 15px; text-align: center; }
    .safe-bg { background: #f0fdf4; border: 1px solid #dcfce7; }
    .warning-bg { background: #fffbeb; border: 1px solid #fef3c7; }
    .danger-bg { background: #fef2f2; border: 1px solid #fee2e2; }

    .progress-bar { height: 8px; background: #e5e7eb; border-radius: 4px; margin: 10px 0; overflow: hidden; }
    .progress-fill { height: 100%; width: 0%; transition: 0.8s ease-in-out; }

    .advice-box {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px dashed rgba(0,0,0,0.1);
      font-size: 0.85rem;
      color: #444;
      line-height: 1.4;
    }
    .advice-box b { color: var(--primary); }

    .footer-note {
      text-align: center;
      font-size: 0.8rem;
      color: #718096;
      margin-top: 40px;
      border-top: 1px solid #d1d9e6;
      padding-top: 20px;
    }
    .footer-note p { margin: 3px 0; }
    .footer-note .year { font-size: 0.7rem; color: #888; }
    .primary-num { color: var(--primary); font-weight: 900; }

    .flex-inputs select,
    .flex-inputs input {
      height: 42px;
      padding: 10px;
      border-radius: 12px;
      box-sizing: border-box;
      text-align: center;
      text-align-last: center;
    }

    .info-overlay{
      display:none;
      position:fixed;
      inset:0;
      background: rgba(15, 23, 42, 0.55);
      z-index: 10000;
      justify-content:center;
      align-items:center;
      padding: 14px;
    }

    .info-modal{
      width: 92%;
      max-width: 360px;
      background: var(--info-modal-bg);
      color: var(--info-modal-text);
      border-radius: 20px;
      box-shadow: 0 18px 45px rgba(0,0,0,0.25);
      overflow: hidden;
      border: 1px solid rgba(15, 23, 42, 0.08);
    }

    .info-modal-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(15, 23, 42, 0.08);
    }

    .info-modal-title{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight: 900;
      font-size: 0.95rem;
    }

    .info-badge{
      width: 28px;
      height: 28px;
      border-radius: 10px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: #e0f2fe;
      color: var(--info-modal-accent);
      font-weight: 900;
    }

    .info-close{
      background: transparent;
      border: none;
      color: #475569;
      font-size: 1.1rem;
      cursor: pointer;
      padding: 6px 10px;
      border-radius: 10px;
    }
    .info-close:hover{
      background: rgba(2, 132, 199, 0.08);
      color: var(--info-modal-text);
    }

    .info-modal-body{
      padding: 14px 16px 6px 16px;
      font-size: 0.92rem;
      line-height: 1.7;
    }

    .info-modal-footer{
      padding: 12px 16px 16px 16px;
    }

    .info-ok{
      width:100%;
      background: var(--info-modal-accent);
      color: white;
      border: none;
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 900;
      cursor: pointer;
      box-shadow: 0 12px 28px rgba(0,0,0,0.12);
    }
    .info-ok:active{ transform: translateY(1px); }

  /* âœ… Fix select RTL across Windows/iPhone â€” keep your exact size & style */
html, body { -webkit-text-size-adjust: 100%; }

button, input, select, textarea{
  font-family: 'Cairo','Segoe UI',Tahoma,sans-serif !important;
}

.flex-inputs input{
  height: 42px !important;
  padding: 6px 10px !important;
  border-radius: 12px !important;
  box-sizing: border-box !important;
  text-align: center !important;
  font-size: 15px !important;
  font-weight: 800 !important;
  line-height: 1.1 !important;
}

/* select ÙÙ‚Ø·: ÙŠÙ…Ù†Ø¹ ØªÙƒØ³ÙŠØ± Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© + ÙŠÙˆØ­Ù‘Ø¯ Ø§Ù„Ø³Ù‡Ù… */
.flex-inputs select{
  direction: rtl !important;
  unicode-bidi: plaintext !important;

  background: #eee !important;
  border: 1.5px solid #edf2f1 !important;
  color: var(--primary) !important;

  -webkit-appearance: none !important;
  appearance: none !important;

  /* Ø³Ù‡Ù…ÙŠÙ† ØµØºÙŠØ±Ø© Ù…Ø«Ù„ Ø´ÙƒÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø¯ÙˆÙ† ØªÙƒØ¨ÙŠØ± */
  padding: 6px 12px 6px 36px !important;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24'%3E%3Cpath fill='%23006699' d='M7.41 15.59 12 11l4.59 4.59L18 14.17l-6-6-6 6z'/%3E%3Cpath fill='%23006699' d='M7.41 8.41 12 13l4.59-4.59L18 9.83l-6 6-6-6z'/%3E%3C/svg%3E") !important;
  background-repeat: no-repeat !important;
  background-position: 12px 50% !important;
}

.flex-inputs select option{
  direction: rtl;
  unicode-bidi: plaintext;
}

    /* ===== Custom Select (Ø«Ø§Ø¨Øª Ø¹Ù„Ù‰ iPhone + Windows) ===== */
.cs {
  position: relative;
  width: 100%;
}

.cs-btn{
  width: 100%;
  height: 42px;
  border-radius: 12px;
  border: 1.5px solid #edf2f1;
  background: #eee;
  color: var(--primary);
  font-family: 'Cairo','Segoe UI',Tahoma,sans-serif;
  font-size: 0.95rem;
  font-weight: 800;
  line-height: 1.2;
  box-sizing: border-box;

  text-align: center;
  cursor: pointer;

  /* Ø³Ù‡Ù…ÙŠÙ† Ø«Ø§Ø¨ØªØ© ÙŠØ³Ø§Ø± */
  padding: 6px 12px 6px 36px;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24'%3E%3Cpath fill='%23006699' d='M7.41 15.59 12 11l4.59 4.59L18 14.17l-6-6-6 6z'/%3E%3Cpath fill='%23006699' d='M7.41 8.41 12 13l4.59-4.59L18 9.83l-6 6-6-6z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: 12px 50%;
}

.cs.open .cs-btn{
  border-color: var(--secondary);
  background: #f8fdff;
}

.cs-menu{
  position: absolute;
  top: calc(100% + 6px);
  right: 0;
  left: 0;
  z-index: 9999;
  background: #fff;
  border: 1px solid #e5e7eb;
  border-radius: 14px;
  box-shadow: 0 12px 30px rgba(0,0,0,0.10);
  padding: 6px;
  display: none;
  max-height: 220px;
  overflow: auto;
}

.cs.open .cs-menu{ display: block; }

.cs-opt{
  padding: 10px 12px;
  border-radius: 12px;
  font-weight: 800;
  color: #0f172a;
  cursor: pointer;
  text-align: center;
}

.cs-opt:hover{
  background: #f0f7f9;
}

.cs-opt.active{
  background: #e0f2fe;
  color: var(--primary);
}
/* âœ… ØªØ«Ø¨ÙŠØª Ø²Ø± Ø§Ù„Ù€ Custom Select Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© (ÙŠÙ…Ù†Ø¹ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù†Øµ) */
.cs-btn{
  -webkit-appearance: none !important;
  appearance: none !important;

  height: 42px !important;
  line-height: 42px !important;      /* âœ… Ø£Ù‡Ù… Ø³Ø·Ø±: ÙŠØ®Ù„ÙŠ Ø§Ù„Ù†Øµ ÙŠØªÙˆØ³Ù‘Ø· ÙˆÙ…Ø§ ÙŠØªØ¬Ø§ÙˆØ² */
  padding: 0 12px 0 36px !important; /* âœ… Ø¨Ø¯ÙˆÙ† padding Ø¹Ù…ÙˆØ¯ÙŠ */

  font-size: 15px !important;        /* âœ… Ø«Ø§Ø¨Øª (Ù„Ø§ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ rem) */
  font-weight: 800 !important;

  white-space: nowrap !important;    /* âœ… ÙŠÙ…Ù†Ø¹ Ù†Ø²ÙˆÙ„ Ø§Ù„Ø³Ø·Ø± */
  overflow: hidden !important;       /* âœ… ÙŠÙ…Ù†Ø¹ Ø®Ø±ÙˆØ¬ Ø§Ù„Ù†Øµ */
  text-overflow: ellipsis !important;/* âœ… Ù„Ùˆ Ø·ÙˆÙ„ Ø§Ù„Ù†Øµ ÙŠÙ‚ØµÙ‡ Ø¨Ù†Ù‚Ø§Ø· */

  border-radius: 12px !important;
  border: 1.5px solid #edf2f1 !important;
  background-color: #eee !important;
  color: var(--primary) !important;
}

/* Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
.cs-opt{
  font-size: 15px !important;
  line-height: 1.2 !important;
  white-space: nowrap !important;
}

function closeAllCS(except=null){
  document.querySelectorAll('.cs.open').forEach(el=>{
    if (except && el === except) return;
    el.classList.remove('open');
    const btn = el.querySelector('.cs-btn');
    if (btn) btn.setAttribute('aria-expanded','false');
  });
}

document.addEventListener('click', (e)=>{
  const opt = e.target.closest('.cs-opt');
  const btn = e.target.closest('.cs-btn');

  if (opt){
    const cs = opt.closest('.cs');
    const courseId = Number(cs.dataset.courseId);
    const idx = Number(cs.dataset.idx);
    const field = cs.dataset.field;
    const value = opt.dataset.value;

    const btnEl = cs.querySelector('.cs-btn');
    btnEl.textContent = opt.textContent;

    cs.querySelectorAll('.cs-opt').forEach(o=>o.classList.remove('active'));
    opt.classList.add('active');

    cs.classList.remove('open');
    btnEl.setAttribute('aria-expanded','false');

    updateMeeting(courseId, idx, field, value, false);
    updateCourseUI(courseId);
    return;
  }

  if (btn){
    const cs = btn.closest('.cs');
    const isOpen = cs.classList.contains('open');
    closeAllCS(cs);
    cs.classList.toggle('open', !isOpen);
    btn.setAttribute('aria-expanded', String(!isOpen));
    return;
  }

  if (!e.target.closest('.cs')) closeAllCS();
});

  </style>
</head>

<body>

  <!-- Guide Modal -->
  <div id="guideModal" class="info-overlay" onclick="toggleModal(false)">
    <div class="info-modal" onclick="event.stopPropagation()">
      <div class="info-modal-header">
        <div class="info-modal-title">
          <span class="info-badge">ğŸ“±</span>
          <span>Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø§Ø³Ø¨Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
        </div>
        <button class="info-close" onclick="toggleModal(false)">âœ•</button>
      </div>

      <div class="info-modal-body" style="text-align:center;">
        <div style="font-weight:900; color:var(--primary); margin-bottom:8px;">ğŸ Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠ iPhone (Safari)</div>
        <div style="font-size:0.82rem; line-height:1.7;">
          Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© â¬†ï¸<br>
          Ø«Ù… Ø§Ø®ØªØ±<br>
          <b style="color:var(--info-modal-accent)">Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</b>
        </div>

        <hr style="border:none; border-top:1px solid rgba(15,23,42,0.10); margin:14px 0;">

        <div style="font-weight:900; color:var(--primary); margin-bottom:8px;">ğŸ¤– Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠ Android (Chrome)</div>
        <div style="font-size:0.82rem; line-height:1.7;">
          Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø«Ù„Ø§Ø« â‹®<br>
          Ø«Ù… Ø§Ø®ØªØ±<br>
          <b style="color:var(--info-modal-accent)">Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</b>
        </div>
      </div>

      <div class="info-modal-footer">
        <button class="info-ok" onclick="toggleModal(false)">ÙÙ‡Ù…Øª</button>
      </div>
    </div>
  </div>

  <!-- Info Modal -->
  <div id="infoOverlay" class="info-overlay" onclick="closeInfoModal()">
    <div class="info-modal" onclick="event.stopPropagation()">
      <div class="info-modal-header">
        <div class="info-modal-title">
          <span class="info-badge" id="infoBadge">i</span>
          <span id="infoTitle">Ù…Ø¹Ù„ÙˆÙ…Ø©</span>
        </div>
        <button class="info-close" onclick="closeInfoModal()">âœ•</button>
      </div>

      <div class="info-modal-body">
        <div id="infoText"></div>
        <div id="infoFormula" class="info-formula" style="display:none;"></div>
      </div>

      <div class="info-modal-footer">
        <button class="info-ok" onclick="closeInfoModal()">ÙÙ‡Ù…Øª</button>
      </div>
    </div>
  </div>

  <div class="app-container">
    <div class="install-banner">
      <div class="install-text">Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ø³Ø¨Ø© ÙƒØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ù‡Ø§ØªÙÙƒ Ø§Ù„Ø°ÙƒÙŠ</div>
      <button class="install-btn" onclick="toggleModal(true)">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¥Ø¶Ø§ÙØ©</button>
    </div>

    <header class="header-section">
      <div class="college-logo"><img src="TVTC_identity.png" alt="Logo"></div>
      <div class="header-text">
        <h1>Ø­Ø§Ø³Ø¨Ø© Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„Ø°ÙƒÙŠØ©</h1>
        
      </div>
    </header>

    <div class="action-bars">
      <button class="add-btn" onclick="addNewCourse()">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù‚Ø±Ø± Ø¬Ø¯ÙŠØ¯</button>
      <button class="reset-all" onclick="clearEverything()">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
    </div>

    <div id="coursesList"></div>

    <footer class="footer-note">
      <div style="display:flex; flex-direction:column; align-items:center; justify-content:center;">
        <p style="font-weight:bold; color:var(--primary); margin:0;">ØªØµÙ…ÙŠÙ… ÙˆØªØ·ÙˆÙŠØ±: Ø£. Ù†ÙˆØ±Ø© Ø§Ù„Ù‚Ø«Ø§Ù…ÙŠ</p>
        <p style="margin:4px 0 0; font-size:0.75rem; color:#555;">Ø§Ù„ÙƒÙ„ÙŠØ© Ø§Ù„ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ø±Ù‚Ù…ÙŠØ© Ù„Ù„Ø¨Ù†Ø§Øª Ø¨ØªØ¨ÙˆÙƒ</p>
        <p style="margin:0 0 4px; font-size:0.72rem; color:#777;">Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ø³Ø¨ ÙˆØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</p>
        <p class="year">1447Ù‡Ù€ | 2026Ù…</p>

        <a href="mailto:norah.a@tvtc.gov.sa"
          style="text-decoration:none; color:#006699; font-size:0.8rem; cursor:pointer;">
          ğŸ“§&nbsp; norah.a@tvtc.gov.sa
        </a>
      </div>
    </footer>
  </div>

<script>
  let courses = JSON.parse(localStorage.getItem('myCourses')) || [];
const selectedWeeks = 16; // Ù„Ù„ØªÙˆØ§ÙÙ‚ ÙÙ‚Ø·

// ===== Ù‚Ø§Ø¹Ø¯Ø© Ø±Ø§ÙŠØ§Øª (Ù…Ø·Ø§Ø¨Ù‚Ø©) =====
const SYSTEM_WEEKS = 19;
const DEPRIVATION_RATE = 0.20;
const EPS = 1e-9;

function ceilLimit(totalLectures){
  return Math.ceil((totalLectures * DEPRIVATION_RATE) - EPS); // Ø£ÙˆÙ„ Ø¹Ø¯Ø¯ ÙŠØ­Ù‚Ù‚ â‰¥20%
}
function floor1(x){
  return Math.floor((Number(x)||0) * 10) / 10; // Floor Ù„Ø¹Ø´Ø±ÙŠ ÙˆØ§Ø­Ø¯
}
function lectureWord(n){
  return (Math.abs(parseInt(n||0,10)) === 1) ? "Ù„Ù‚Ø§Ø¡" : "Ù„Ù‚Ø§Ø¡Ø§Øª";
}


  function $(id){ return document.getElementById(id); }

  // ===== Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ (Ø«Ø§Ø¨Øª) =====
  const TERM_START = parseDMY('18-1-2026');
  const TERM_END   = parseDMY('21-5-2026');

  const HOLIDAYS = new Set([
    '22-2-2026',
    '22-3-2026',
    '23-3-2026',
    '24-3-2026'
  ].map(normDMYKey));

  const GAP_START = parseDMY('6-3-2026');
  const GAP_END   = parseDMY('21-3-2026');

  const WEEKDAY_INDEX = {
    'Ø§Ù„Ø£Ø­Ø¯': 0,
    'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†': 1,
    'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡': 2,
    'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡': 3,
    'Ø§Ù„Ø®Ù…ÙŠØ³': 4,
    'Ø§Ù„Ø¬Ù…Ø¹Ø©': 5,
    'Ø§Ù„Ø³Ø¨Øª': 6
  };

  function parseDMY(dmy){
    const [d,m,y] = String(dmy).split('-').map(Number);
    return new Date(y, (m||1)-1, d||1, 12, 0, 0);
  }
  function normDMYKey(dmy){
    const [d,m,y] = String(dmy).split('-').map(Number);
    return `${d}-${m}-${y}`;
  }
  function dateToDMYKey(dt){
    return `${dt.getDate()}-${dt.getMonth()+1}-${dt.getFullYear()}`;
  }
  function inRange(dt, a, b){
    const t = dt.getTime();
    return t >= a.getTime() && t <= b.getTime();
  }
  function isExcludedDate(dt){
    const key = dateToDMYKey(dt);
    if (HOLIDAYS.has(key)) return true;
    if (inRange(dt, GAP_START, GAP_END)) return true;
    return false;
  }
  function countDayOccurrences(dayName){
    const target = WEEKDAY_INDEX[dayName];
    if (target === undefined) return 0;

    let count = 0;
    const cur = new Date(TERM_START.getTime());
    while (cur.getTime() <= TERM_END.getTime()){
      if (cur.getDay() === target && !isExcludedDate(cur)) count++;
      cur.setDate(cur.getDate() + 1);
    }
    return count;
  }

  function hourWord(n) {
    let v = Math.abs(parseFloat(n));
    if (v === 0) return "Ø³Ø§Ø¹Ø©";
    if (v >= 1 && v <= 2) return "Ø³Ø§Ø¹Ø©";
    if (v >= 3 && v <= 10) return "Ø³Ø§Ø¹Ø§Øª";
    return "Ø³Ø§Ø¹Ø©";
  }

  function getLectureText(n) {
    let v = Math.abs(n);
    if (v === 0) return "";
    if (v === 1) return `<b class="primary-num">1</b> Ù…Ø­Ø§Ø¶Ø±Ø©`;
    if (v === 2) return `<b class="primary-num">2</b> Ù…Ø­Ø§Ø¶Ø±Ø©`;
    if (v >= 3 && v <= 10) return `<b class="primary-num">${v}</b> Ù…Ø­Ø§Ø¶Ø±Ø§Øª`;
    return `<b class="primary-num">${v}</b> Ù…Ø­Ø§Ø¶Ø±Ø©`;
  }

  function toggleModal(show) {
    const modal = $('guideModal');
    if (!modal) return;
    modal.style.display = show ? 'flex' : 'none';
  }

  function fixNumbers(str) {
    return String(str || '')
      .replace(/[Ù -Ù©]/g, d => String(d.charCodeAt(0) - 1632))
      .replace(/[Û°-Û¹]/g, d => String(d.charCodeAt(0) - 1776))
      .replace(/[^\d]/g, '');
  }

  function addNewCourse() {
  courses.push({
    id: Date.now(),
    name: 'Ø§Ø³Ù… Ø§Ù„Ù…Ù‚Ø±Ø±',
    meetings: [{ day: 'Ø§Ù„Ø£Ø­Ø¯', dur: 2, type: 'Ù†Ø¸Ø±ÙŠ', absent: '' }]
  });
  renderCourses();
}


  function openInfoModal({title='Ù…Ø¹Ù„ÙˆÙ…Ø©', text='', formula='', badge='i'}) {
    const t = $('infoTitle'), tx = $('infoText'), b = $('infoBadge'), f = $('infoFormula'), ov = $('infoOverlay');
    if (!t || !tx || !b || !f || !ov) return;

    t.textContent = title;
    tx.innerHTML = text;
    b.textContent = badge;

    if (formula && formula.trim() !== '') {
      f.style.display = 'block';
      f.textContent = formula;
    } else {
      f.style.display = 'none';
      f.textContent = '';
    }
    ov.style.display = 'flex';
  }

  function closeInfoModal() {
    const ov = $('infoOverlay');
    if (!ov) return;
    ov.style.display = 'none';
  }

  function openLimitInfo(courseId){
  const course = courses.find(c => c.id === courseId);
  if (!course) return;

  const s = computeCourseState(course);

  const totalAll = s.totalLecturesAll;
  const limitAll = s.limitAll;

  const theoryBlock = s.hasTheory ? `
    <div style="margin-top:8px; padding:10px 12px; border-radius:14px; background:#f8fafc; border:1px solid rgba(15,23,42,0.08);">
      <div style="font-weight:900; color:#0f172a; margin-bottom:6px;">Ø§Ù„Ù†Ø¸Ø±ÙŠ</div>
      â€¢ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù„Ù‚Ø§Ø¡Ø§Øª: <b class="num">${s.totalByType['Ù†Ø¸Ø±ÙŠ']}</b> Ù„Ù‚Ø§Ø¡<br>
      â€¢ Ø­Ø¯ Ø§Ù„Ø­Ø±Ù…Ø§Ù† (20%): <b class="num">${s.limitByType['Ù†Ø¸Ø±ÙŠ']}</b> ØºÙŠØ§Ø¨
    </div>
  ` : '';

  const pracBlock = s.hasPrac ? `
    <div style="margin-top:8px; padding:10px 12px; border-radius:14px; background:#f8fafc; border:1px solid rgba(15,23,42,0.08);">
      <div style="font-weight:900; color:#0f172a; margin-bottom:6px;">Ø§Ù„Ø¹Ù…Ù„ÙŠ</div>
      â€¢ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù„Ù‚Ø§Ø¡Ø§Øª: <b class="num">${s.totalByType['Ø¹Ù…Ù„ÙŠ']}</b> Ù„Ù‚Ø§Ø¡<br>
      â€¢ Ø­Ø¯ Ø§Ù„Ø­Ø±Ù…Ø§Ù† (20%): <b class="num">${s.limitByType['Ø¹Ù…Ù„ÙŠ']}</b> ØºÙŠØ§Ø¨
    </div>
  ` : '';

  const text = `
    <div style="font-weight:900; margin-bottom:6px; color:var(--primary);">
      Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø±Ù…Ø§Ù† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†Ø¸Ø§Ù… Ø±Ø§ÙŠØ§Øª :
    </div>

    <div style="margin-top:8px; line-height:1.9;">
      â€¢ Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ù‚Ø§Ø¡Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©: <b class="num">${s.weeklyMeetings}</b><br>
      â€¢ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù„Ù‚Ø§Ø¡Ø§Øª ÙÙŠ Ø§Ù„ØªØ±Ù…: <b class="num">${totalAll}</b> Ù„Ù‚Ø§Ø¡
    </div>

    <div class="formula-line" style="margin-top:10px;">
      ( <span class="num">${totalAll}</span> Ù„Ù‚Ø§Ø¡ ) Ã— <span class="num">20%</span>
      = <span class="num">${(totalAll * 0.20).toFixed(1).replace(/\\.0+$/,'')}</span> Ù„Ù‚Ø§Ø¡
    </div>

    <div style="margin-top:8px; font-weight:900; color:#0f172a;">
      ğŸ”´ ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø­Ø±Ù…Ø§Ù† Ø¹Ù†Ø¯ <span class="num">${limitAll}</span> ØºÙŠØ§Ø¨
    </div>

    ${(s.hasTheory || s.hasPrac) ? `
      <hr style="border:none; border-top:1px solid rgba(15,23,42,0.10); margin:12px 0;">
      <div style="font-weight:900; color:#334155; margin-bottom:6px;">ØªÙØµÙŠÙ„ Ø§Ù„Ø´ÙØ¹Ø¨:</div>
      ${theoryBlock}
      ${pracBlock}
      <div style="margin-top:10px; color:#ef4444; font-weight:900;">
        ğŸ”´ Ø§Ù„Ù…Ù‚Ø±Ø± Ù†Ù…Ø· (Ù†Ø¸Ø±ÙŠ/Ø¹Ù…Ù„ÙŠ) Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø±Ù…Ø§Ù† Ø¨Ø£Ø­Ø¯Ù‡Ù…Ø§ ÙŠØ¤Ø¯ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø±Ù…Ø§Ù† ÙÙŠ ÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ù‚Ø±Ø±
      </div>
    ` : ''}
  `;

  openInfoModal({ title: 'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø­Ø³Ø§Ø¨', text, badge: 'i', formula: '' });
}


  function ensureMeetings(course){
  if (!Array.isArray(course.meetings)) course.meetings = [];
  course.meetings = course.meetings.slice(0,3);

  if (course.meetings.length === 0) {
    course.meetings.push({ day:'Ø§Ù„Ø£Ø­Ø¯', dur:2, type:'Ù†Ø¸Ø±ÙŠ', absent:'' });
  }

  course.meetings.forEach(m => {
    if (!m.day) m.day = 'Ø§Ù„Ø£Ø­Ø¯';
    m.dur = Number(m.dur) === 1 ? 1 : 2;     // Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø· (Ù„Ø§ ÙŠØ¯Ø®Ù„ Ø¨Ø§Ù„Ø­Ø³Ø¨Ø©)
    if (!m.type) m.type = 'Ù†Ø¸Ø±ÙŠ';            // âœ… Ø§Ù„Ø¬Ø¯ÙŠØ¯
    if (m.absent === undefined) m.absent = '';
  });
}

  function addMeeting(courseId){
  const i = courses.findIndex(c => c.id === courseId);
  if (i === -1) return;

  ensureMeetings(courses[i]);
  if (courses[i].meetings.length >= 3) return;

  courses[i].meetings.push({ day:'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', dur:1, type:'Ø¹Ù…Ù„ÙŠ', absent:'' });
  renderCourses();
}


  function removeMeeting(courseId){
    const i = courses.findIndex(c => c.id === courseId);
    if (i === -1) return;

    ensureMeetings(courses[i]);
    if (courses[i].meetings.length <= 1) return;

    courses[i].meetings.pop();
    renderCourses();
  }

  function updateMeeting(courseId, idx, field, value, doRender = true){
  const i = courses.findIndex(c => c.id === courseId);
  if (i === -1) return;

  ensureMeetings(courses[i]);
  const m = courses[i].meetings[idx];
  if (!m) return;

  if (field === 'day') m.day = value;
  if (field === 'dur') m.dur = Number(value) === 1 ? 1 : 2; // Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·
  if (field === 'type') m.type = (value === 'Ø¹Ù…Ù„ÙŠ') ? 'Ø¹Ù…Ù„ÙŠ' : 'Ù†Ø¸Ø±ÙŠ';                     // âœ… Ø§Ù„Ø¬Ø¯ÙŠØ¯
  if (field === 'absent') m.absent = fixNumbers(value);

  // âœ… Ø¥Ø°Ø§ ÙƒÙ†Ø§ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù€ Custom Select Ù…Ø§ Ù†Ø­ØªØ§Ø¬ renderCourses ÙƒÙ„ Ù…Ø±Ø©
if (doRender) {
  renderCourses();
} else {
  localStorage.setItem('myCourses', JSON.stringify(courses));
}

}


  function computeCourseState(course){
  ensureMeetings(course);

  const cleanMeetings = (course.meetings || []).slice(0, 3)
    .filter(m => m && m.day && (Number(m.dur) === 1 || Number(m.dur) === 2))
    .map(m => ({
      day: m.day,
      dur: Number(m.dur),                     // Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·
      type: (m.type === 'Ø¹Ù…Ù„ÙŠ') ? 'Ø¹Ù…Ù„ÙŠ' : 'Ù†Ø¸Ø±ÙŠ',
      absent: parseInt(m.absent, 10) || 0     // âœ… ØºÙŠØ§Ø¨Ø§Øª Ø¨Ø§Ù„Ù„Ù‚Ø§Ø¡Ø§Øª
    }));

  // Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ù‚Ø§Ø¡Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© Ù„ÙƒÙ„ Ø´Ù‚
  const weeklyByType = { 'Ù†Ø¸Ø±ÙŠ': 0, 'Ø¹Ù…Ù„ÙŠ': 0 };
  cleanMeetings.forEach(m => weeklyByType[m.type]++);

  // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù„Ù‚Ø§Ø¡Ø§Øª ÙÙŠ Ø§Ù„ØªØ±Ù… Ù„ÙƒÙ„ Ø´Ù‚
  const totalByType = {
    'Ù†Ø¸Ø±ÙŠ': weeklyByType['Ù†Ø¸Ø±ÙŠ'] * SYSTEM_WEEKS,
    'Ø¹Ù…Ù„ÙŠ': weeklyByType['Ø¹Ù…Ù„ÙŠ'] * SYSTEM_WEEKS
  };

  // Ø­Ø¯ Ø§Ù„Ø­Ø±Ù…Ø§Ù† Ù„ÙƒÙ„ Ø´Ù‚ (Ceil)
  const limitByType = {
    'Ù†Ø¸Ø±ÙŠ': ceilLimit(totalByType['Ù†Ø¸Ø±ÙŠ']),
    'Ø¹Ù…Ù„ÙŠ': ceilLimit(totalByType['Ø¹Ù…Ù„ÙŠ'])
  };

  // Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„ÙƒÙ„ Ø´Ù‚
  const absentByType = { 'Ù†Ø¸Ø±ÙŠ': 0, 'Ø¹Ù…Ù„ÙŠ': 0 };
  cleanMeetings.forEach(m => { absentByType[m.type] += m.absent; });

  // Ø§Ù„Ù†Ø³Ø¨Ø© Ù„ÙƒÙ„ Ø´Ù‚ (Ù„Ø¹Ø±Ø¶Ù‡Ø§ Ø¨Ù€ Floor)
  function pct(abs, total){
    if (!total) return 0;
    return (abs / total) * 100;
  }

  const pctTheory = pct(absentByType['Ù†Ø¸Ø±ÙŠ'], totalByType['Ù†Ø¸Ø±ÙŠ']);
  const pctPrac   = pct(absentByType['Ø¹Ù…Ù„ÙŠ'], totalByType['Ø¹Ù…Ù„ÙŠ']);

  // Ù†Ø¹Ø±Ø¶ "Ø§Ù„Ø£Ø´Ø¯" (Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù†Ø³Ø¨Ø©) Ø­ØªÙ‰ ÙŠÙƒÙˆÙ† Ø§Ù„ØªØ­Ø°ÙŠØ± ÙˆØ§Ø¶Ø­
  const hasTheory = totalByType['Ù†Ø¸Ø±ÙŠ'] > 0;
  const hasPrac   = totalByType['Ø¹Ù…Ù„ÙŠ'] > 0;

  let focusType = 'Ù†Ø¸Ø±ÙŠ';
  if (hasTheory && hasPrac) {
    focusType = (pctPrac > pctTheory) ? 'Ø¹Ù…Ù„ÙŠ' : 'Ù†Ø¸Ø±ÙŠ';
  } else if (hasPrac) {
    focusType = 'Ø¹Ù…Ù„ÙŠ';
  }

  const focusPctRaw = (focusType === 'Ø¹Ù…Ù„ÙŠ') ? pctPrac : pctTheory;
  const percentShown = floor1(focusPctRaw);

  // Ø§Ù„Ø­Ø±Ù…Ø§Ù† Ø¥Ø°Ø§ Ø£ÙŠ Ø´Ù‚ ÙˆØµÙ„ Ø­Ø¯Ù‘Ù‡
  const deprivedTheory = hasTheory && (absentByType['Ù†Ø¸Ø±ÙŠ'] + EPS >= limitByType['Ù†Ø¸Ø±ÙŠ']);
  const deprivedPrac   = hasPrac   && (absentByType['Ø¹Ù…Ù„ÙŠ'] + EPS >= limitByType['Ø¹Ù…Ù„ÙŠ']);
  const isDeprived = deprivedTheory || deprivedPrac;

  let statusClass = 'safe-bg';
  let statusColor = 'var(--safe)';
  let msg = 'ğŸŸ¢ ÙˆØ¶Ø¹Ùƒ Ø¢Ù…Ù† ÙˆÙ…Ø³ØªÙ‚Ø±';

  if (isDeprived) {
    statusClass = 'danger-bg';
    statusColor = 'var(--danger)';
    msg = 'ğŸ”´ Ø­Ø§Ù„Ø© Ø­Ø±Ù…Ø§Ù†';
  } else if (percentShown >= 15) {
    statusClass = 'warning-bg';
    statusColor = 'var(--orange)';
    msg = 'ğŸŸ  ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù‚ØªØ±Ø¨Øª Ù…Ù† Ø§Ù„Ø­Ø±Ù…Ø§Ù†';
  } else if (percentShown >= 10) {
    statusClass = 'warning-bg';
    statusColor = 'var(--warning)';
    msg = 'ğŸŸ¡ Ø§Ù†ØªØ¨Ø§Ù‡: Ø¨Ø¯Ø£ Ø±ØµÙŠØ¯Ùƒ Ø¨Ø§Ù„Ù†Ù‚ØµØ§Ù†';
  }

  function fmtInt(n){ return String(Math.max(0, parseInt(n||0,10))); }

  // Ù†Øµ Ø§Ù„ØªÙØµÙŠÙ„: Ù†Ø¸Ø±ÙŠ + Ø¹Ù…Ù„ÙŠ
  let detailLines = [];
  if (hasTheory){
    detailLines.push(`Ø§Ù„Ù†Ø¸Ø±ÙŠ: ${fmtInt(absentByType['Ù†Ø¸Ø±ÙŠ'])}/${fmtInt(limitByType['Ù†Ø¸Ø±ÙŠ'])} Ù„Ù‚Ø§Ø¡`);
  }
  if (hasPrac){
    detailLines.push(`Ø§Ù„Ø¹Ù…Ù„ÙŠ: ${fmtInt(absentByType['Ø¹Ù…Ù„ÙŠ'])}/${fmtInt(limitByType['Ø¹Ù…Ù„ÙŠ'])} Ù„Ù‚Ø§Ø¡`);
  }
  const detailHTML = detailLines.length
    ? `<div style="margin-top:6px; font-size:0.78rem; color:#475569; font-weight:800; line-height:1.6;">${detailLines.join('<br>')}</div>`
    : '';

  // Ù†Øµ Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯
    // Ù†Øµ Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ (ØµÙŠØºØ© Ù…ÙˆØ­Ø¯Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ©)
// Ù†Øµ Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ (ØµÙŠØºØ© Ø§Ø­ØªØ±Ø§ÙÙŠØ© + Ø£Ù„ÙˆØ§Ù† Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©)
let advice = '';

const remainingByType = {
  'Ù†Ø¸Ø±ÙŠ': hasTheory ? ((limitByType['Ù†Ø¸Ø±ÙŠ'] - 1) - absentByType['Ù†Ø¸Ø±ÙŠ']) : null,
  'Ø¹Ù…Ù„ÙŠ': hasPrac   ? ((limitByType['Ø¹Ù…Ù„ÙŠ'] - 1) - absentByType['Ø¹Ù…Ù„ÙŠ']) : null
};

if (isDeprived) {

  advice = `<div class="advice-box" style="color:#dc2626; font-weight:900;">
              ØªØ¬Ø§ÙˆØ²ØªÙ Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­.
            </div>`;

} else {

  let lines = [];

  function buildLine(type){
  const remaining = remainingByType[type];
  const absent = absentByType[type];
  const limit = limitByType[type];

  // Ù„ÙˆÙ† Ø¹Ø¨Ø§Ø±Ø© "ÙŠØªØ¨Ù‚Ù‰ Ù„Ùƒ"
  let remainColor = '#16a34a'; // Ø£Ø®Ø¶Ø± Ø§ÙØªØ±Ø§Ø¶ÙŠ

  if (remaining === 1){
    remainColor = '#facc15'; // Ø£ØµÙØ±
  }

  if (remaining === 0){
    remainColor = '#fb923c'; // Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ù‚ÙˆÙŠ
  }

  return `
    <div style="margin-bottom:6px; line-height:1.8; font-weight:700;">

      <b style="color:var(--primary); font-weight:900;">Ø§Ù„${type}:</b>


      ØºÙŠØ§Ø¨Ùƒ 
      <span class="primary-num">${absent}</span> 
      Ù…Ù† 
      <span class="primary-num">${limit}</span>

      â€”

      <span style="color:${remainColor}; font-weight:900;">
        ÙŠØªØ¨Ù‚Ù‰ Ù„Ùƒ 
        <span class="primary-num">${remaining}</span> 
        ${lectureWord(remaining)}
      </span>

    </div>
  `;
}


  if (hasTheory) lines.push(buildLine('Ù†Ø¸Ø±ÙŠ'));
  if (hasPrac)   lines.push(buildLine('Ø¹Ù…Ù„ÙŠ'));

  advice = `
    <div class="advice-box" style="line-height:1.9;">
      ${lines.join('')}
    </div>
  `;
}


  // Ù„Ù„Ø¹Ø±Ø¶ Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
  const weeklyMeetings = cleanMeetings.length; // Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ù‚Ø§Ø¡Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© (Ø¥Ø¬Ù…Ø§Ù„ÙŠ)
  const totalLecturesAll = (weeklyMeetings * SYSTEM_WEEKS);
  const absentAll = absentByType['Ù†Ø¸Ø±ÙŠ'] + absentByType['Ø¹Ù…Ù„ÙŠ'];
  const limitAll = ceilLimit(totalLecturesAll); // Ù„Ù„Ù…Ø¹Ù„ÙˆÙ…Ø© ÙÙ‚Ø·ØŒ Ù„ÙƒÙ† Ø§Ù„Ø­Ø±Ù…Ø§Ù† ÙØ¹Ù„ÙŠØ§Ù‹ Ø¨Ø§Ù„Ø´ÙØ¹Ø¨ Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ø´Ù‚ÙŠÙ†

  return {
    weeklyMeetings,
    percentShown,
    statusClass, statusColor, msg, advice,

    // ØªÙØµÙŠÙ„
    hasTheory, hasPrac,
    weeklyByType, totalByType, limitByType, absentByType,

    // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø§Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ù„Ø¹Ø±Ø¶)
    totalLecturesAll, absentAll, limitAll
  };
}

  function updateCourseUI(courseId){
  const course = courses.find(c => c.id === courseId);
  if (!course) return;

  const s = computeCourseState(course);

  const box = document.getElementById(`resultBox-${courseId}`);
  const msgEl = document.getElementById(`statusMsg-${courseId}`);
  const pctEl = document.getElementById(`percentTxt-${courseId}`);
  const barEl = document.getElementById(`barFill-${courseId}`);
  const absEl = document.getElementById(`absentTxt-${courseId}`);
  const limEl = document.getElementById(`limitTxt-${courseId}`);
  const advEl = document.getElementById(`adviceBox-${courseId}`);

  if (!box || !msgEl || !pctEl || !barEl || !absEl || !limEl || !advEl) return;

  box.classList.remove('safe-bg','warning-bg','danger-bg');
  box.classList.add(s.statusClass);

  msgEl.textContent = s.msg;
  msgEl.style.color = s.statusColor;

  pctEl.textContent = `${Number(s.percentShown).toFixed(1).replace(/\.0+$/,'')}%`;

  const w = Math.min((s.percentShown / 20) * 100, 100);
  barEl.style.width = `${w}%`;
  barEl.style.background = s.statusColor;

  absEl.textContent = `ØºÙŠØ§Ø¨Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${s.absentAll} ${lectureWord(s.absentAll)}`;

  // Ù„ÙˆÙ† Ø²Ø± i Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
  const infoIconClass =
    (s.statusClass === 'danger-bg') ? 'danger' :
    (s.percentShown >= 10) ? 'warn' : '';

  // âœ… Ù†Ø¹ÙŠØ¯ Ø¨Ù†Ø§Ø¡ limitTxt Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¹Ø´Ø§Ù† Ù†Ø¶Ù…Ù† onclick Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø¨Ø§Ù„Ù„Ù‚Ø§Ø¡Ø§Øª)
  limEl.innerHTML = `
    Ø­Ø¯ Ø§Ù„Ø­Ø±Ù…Ø§Ù†: ${s.limitAll} ${lectureWord(s.limitAll)}
    <span class="info-icon ${infoIconClass}" onclick="openLimitInfo(${courseId})">i</span>
  `;

  advEl.innerHTML = s.advice;

  localStorage.setItem('myCourses', JSON.stringify(courses));
}


  // ============================
  // âœ… renderCourses (ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù€ template literal)
  // ============================
  function renderCourses() {
  const list = $('coursesList');
  if (!list) return;
  list.innerHTML = '';

  courses.forEach(course => {
    ensureMeetings(course);

    const s = computeCourseState(course);

    const card = document.createElement('div');
    card.className = 'course-card';

    card.innerHTML = `
      <button class="delete-course" onclick="deleteCourse(${course.id})">âœ•</button>

      <input type="text" class="course-title"
        value="${course.name}"
        onchange="updateCourse(${course.id}, 'name', this.value)">

      <div class="input-group">
        <label style="text-align:center;">Ù„Ù‚Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ù‚Ø±Ø± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</label>

        <div id="meetWrap-${course.id}"></div>

        <div style="display:flex; gap:8px; margin-top:10px;">
          <button type="button" class="reset-all" style="flex:1;"
            onclick="addMeeting(${course.id})">â• Ø¥Ø¶Ø§ÙØ© Ù„Ù‚Ø§Ø¡</button>
          <button type="button" class="reset-all" style="flex:1;"
            onclick="removeMeeting(${course.id})">â– Ø­Ø°Ù Ø¢Ø®Ø± Ù„Ù‚Ø§Ø¡</button>
        </div>

        <div style="margin-top:10px; font-size:0.82rem; color:#475569; font-weight:700; text-align:center;">
          Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ù‚Ø§Ø¡Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©: <b class="primary-num">${s.weeklyMeetings}</b> Ù„Ù‚Ø§Ø¡
        </div>
      </div>

      <div class="result-area ${s.statusClass}" id="resultBox-${course.id}">
        <div id="statusMsg-${course.id}"
            style="font-size:0.95rem; font-weight:800; color:${s.statusColor}; margin-bottom:10px;">
          ${s.msg}
        </div>

        <div style="display:flex; justify-content:space-between; align-items:baseline; margin-bottom:5px;">
          <span id="percentTxt-${course.id}"
                style="font-size:1.8rem; font-weight:900; color:var(--primary);">
            ${s.percentShown.toFixed(1).replace(/\\.0+$/,'')}%
          </span>
          <span style="font-size:0.85rem; color:#718096; font-weight:bold;">Ù…Ù† Ø£ØµÙ„ 20%</span>
        </div>

        <div class="progress-bar">
          <div id="barFill-${course.id}" class="progress-fill"
              style="width:${Math.min((s.percentShown / 20) * 100, 100)}%; background:${s.statusColor}">
          </div>
        </div>

        <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:#555; font-weight:700; margin-top:5px;">
          <span id="absentTxt-${course.id}">
            ØºÙŠØ§Ø¨Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${s.absentAll} ${lectureWord(s.absentAll)}
          </span>

          <span id="limitTxt-${course.id}">
            Ø­Ø¯ Ø§Ù„Ø­Ø±Ù…Ø§Ù†: ${s.limitAll} ${lectureWord(s.limitAll)}
            <span class="info-icon ${s.statusClass==='danger-bg'?'danger':(s.percentShown>=10?'warn':'')}"
                  onclick="openLimitInfo(${course.id})">i</span>
          </span>
        </div>

        <div id="adviceBox-${course.id}">
          ${s.advice}
        </div>
      </div>
    `;

    list.appendChild(card);

    // âœ… Ø¨Ù†Ø§Ø¡ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù„Ù‚Ø§Ø¡Ø§Øª (Ø§Ù„ÙŠÙˆÙ…/Ø§Ù„Ù†ÙˆØ¹/Ø§Ù„Ù…Ø¯Ø©/Ø§Ù„ØºÙŠØ§Ø¨)
    const wrap = card.querySelector(`#meetWrap-${course.id}`);
    if (wrap) {
wrap.innerHTML = (course.meetings || []).slice(0, 3).map((m, idx) => `
  <div class="flex-inputs" style="margin-top:8px;">
    <div>
      <div class="input-sub-label">Ø§Ù„ÙŠÙˆÙ…</div>

      <div class="cs" data-course-id="${course.id}" data-idx="${idx}" data-field="day">
        <button type="button" class="cs-btn" aria-expanded="false">${m.day}</button>
        <div class="cs-menu">
          ${['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³'].map(d => `
            <div class="cs-opt ${m.day===d?'active':''}" data-value="${d}">${d}</div>
          `).join('')}
        </div>
      </div>
    </div>

    <div>
      <div class="input-sub-label">Ø§Ù„Ù†ÙˆØ¹</div>

      <div class="cs" data-course-id="${course.id}" data-idx="${idx}" data-field="type">
        <button type="button" class="cs-btn" aria-expanded="false">${(m.type==='Ø¹Ù…Ù„ÙŠ')?'Ø¹Ù…Ù„ÙŠ':'Ù†Ø¸Ø±ÙŠ'}</button>
        <div class="cs-menu">
          ${['Ù†Ø¸Ø±ÙŠ','Ø¹Ù…Ù„ÙŠ'].map(t => `
            <div class="cs-opt ${((m.type==='Ø¹Ù…Ù„ÙŠ')? 'Ø¹Ù…Ù„ÙŠ':'Ù†Ø¸Ø±ÙŠ')===t?'active':''}" data-value="${t}">${t}</div>
          `).join('')}
        </div>
      </div>
    </div>

    <div>
      <div class="input-sub-label">Ù…Ø¯Ø© Ø§Ù„Ù„Ù‚Ø§Ø¡</div>

      <div class="cs" data-course-id="${course.id}" data-idx="${idx}" data-field="dur">
        <button type="button" class="cs-btn" aria-expanded="false">${Number(m.dur)===2?'Ø³Ø§Ø¹ØªÙŠÙ†':'Ø³Ø§Ø¹Ø©'}</button>
        <div class="cs-menu">
          <div class="cs-opt ${Number(m.dur)===1?'active':''}" data-value="1">Ø³Ø§Ø¹Ø©</div>
          <div class="cs-opt ${Number(m.dur)===2?'active':''}" data-value="2">Ø³Ø§Ø¹ØªÙŠÙ†</div>
        </div>
      </div>
    </div>

    <div>
      <div class="input-sub-label">Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„ØºÙŠØ§Ø¨</div>
      <input type="text" inputmode="numeric" pattern="[0-9]*"
        value="${m.absent ?? ''}" placeholder="0"
        oninput="
          this.value = fixNumbers(this.value);
          updateMeeting(${course.id}, ${idx}, 'absent', this.value, false);
          updateCourseUI(${course.id});
        "
        onchange="updateMeeting(${course.id}, ${idx}, 'absent', this.value, true)">
    </div>
  </div>
`).join('');

    }
  });

  localStorage.setItem('myCourses', JSON.stringify(courses));
}


  function updateCourse(id, field, value) {
    const index = courses.findIndex(c => c.id === id);
    if (index !== -1) {
      courses[index][field] = value;
      renderCourses();
    }
  }

  function deleteCourse(id) {
    if (confirm('Ø­Ø°Ù Ø§Ù„Ù…Ù‚Ø±Ø±ØŸ')) {
      courses = courses.filter(c => c.id !== id);
      renderCourses();
    }
  }

  function clearEverything() {
    if (confirm('Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· ÙƒØ§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ')) {
      courses = [];
      localStorage.removeItem('myCourses');
      renderCourses();
    }
  }

  // ===== Custom Select handlers =====
function closeAllCS(except = null){
  document.querySelectorAll('.cs.open').forEach(el => {
    if (except && el === except) return;
    el.classList.remove('open');
    const btn = el.querySelector('.cs-btn');
    if (btn) btn.setAttribute('aria-expanded', 'false');
  });
}

// ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚
document.addEventListener('click', (e) => {
  const btn = e.target.closest('.cs-btn');
  const opt = e.target.closest('.cs-opt');

  // Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù†ØµØ±
  if (opt){
    const cs = opt.closest('.cs');
    const courseId = Number(cs.dataset.courseId);
    const idx = Number(cs.dataset.idx);
    const field = cs.dataset.field;
    const value = opt.dataset.value;

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Øµ
    const btnEl = cs.querySelector('.cs-btn');
    btnEl.textContent = opt.textContent;

    // ØªÙØ¹ÙŠÙ„ active
    cs.querySelectorAll('.cs-opt').forEach(o => o.classList.remove('active'));
    opt.classList.add('active');

    // Ø£ØºÙ„Ù‚
    cs.classList.remove('open');
    btnEl.setAttribute('aria-expanded','false');

    // âœ… Ø§Ø±Ø¨Ø·Ù‡Ø§ Ø¨Ø¯ÙˆØ§Ù„Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    updateMeeting(courseId, idx, field, value, true);
    updateCourseUI(courseId);
    return;
  }

  // ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
  if (btn){
    const cs = btn.closest('.cs');
    const isOpen = cs.classList.contains('open');
    closeAllCS(cs);
    cs.classList.toggle('open', !isOpen);
    btn.setAttribute('aria-expanded', String(!isOpen));
    return;
  }

  // Ø¶ØºØ· Ø®Ø§Ø±Ø¬Ù‡Ø§ = Ø¥ØºÙ„Ø§Ù‚
  if (!e.target.closest('.cs')) closeAllCS();
});


  window.onload = function () {
    courses.forEach(c => ensureMeetings(c));
    renderCourses();
  };
</script>

</body>
</html>
